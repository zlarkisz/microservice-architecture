# Homework 04: Transactions & Distributed Locks

## –ó–º—ñ—Å—Ç

- [–ó–∞–≤–¥–∞–Ω–Ω—è 1: Sequence –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–æ—Ü–µ—Å—É –≤—ñ–¥–∫–∞—Ç—É](#–∑–∞–≤–¥–∞–Ω–Ω—è-1-sequence-–¥—ñ–∞–≥—Ä–∞–º–∞-–ø—Ä–æ—Ü–µ—Å—É-–≤—ñ–¥–∫–∞—Ç—É)
  - [1.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏](#11-–∞—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞-—Å–∏—Å—Ç–µ–º–∏)
  - [1.2 Saga Pattern](#12-saga-pattern)
  - [1.3 Orchestration vs Choreography](#13-orchestration-vs-choreography)
  - [1.4 –î—ñ–∞–≥—Ä–∞–º–∞](#14-–¥—ñ–∞–≥—Ä–∞–º–∞)
  - [1.5 –ï—Ç–∞–ø–∏ –ø—Ä–æ—Ü–µ—Å—É](#15-–µ—Ç–∞–ø–∏-–ø—Ä–æ—Ü–µ—Å—É)
  - [1.6 –¢–∏–ø–∏ —Å—Ç—Ä—ñ–ª–æ–∫](#16-—Ç–∏–ø–∏-—Å—Ç—Ä—ñ–ª–æ–∫)
- [–ó–∞–≤–¥–∞–Ω–Ω—è 2: –õ–æ–≥—ñ–∫–∞ –ª–æ–∫—É —Ç–æ–≤–∞—Ä—É](#–∑–∞–≤–¥–∞–Ω–Ω—è-2-–ª–æ–≥—ñ–∫–∞-–ª–æ–∫—É-—Ç–æ–≤–∞—Ä—É)
  - [2.1 –ü—Ä–æ–±–ª–µ–º–∞: Race Condition](#21-–ø—Ä–æ–±–ª–µ–º–∞-race-condition)
  - [2.2 –†—ñ—à–µ–Ω–Ω—è: Distributed Lock (Redis)](#22-—Ä—ñ—à–µ–Ω–Ω—è-distributed-lock-redis)
  - [2.3 –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–±–æ—Ç–∏](#23-–∞–ª–≥–æ—Ä–∏—Ç–º-—Ä–æ–±–æ—Ç–∏)
  - [2.4 –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É](#24-–ø—Ä–∏–∫–ª–∞–¥-–∫–æ–¥—É)
- [–ó–∞–≤–¥–∞–Ω–Ω—è 3: –©–æ –º–æ–∂–µ –ø—ñ—Ç–∏ –Ω–µ —Ç–∞–∫ –∑ –ª–æ–∫–æ–º](#–∑–∞–≤–¥–∞–Ω–Ω—è-3-—â–æ-–º–æ–∂–µ-–ø—ñ—Ç–∏-–Ω–µ-—Ç–∞–∫-–∑-–ª–æ–∫–æ–º)
  - [3.1 Lock –Ω–µ –∑–≤—ñ–ª—å–Ω–∏–≤—Å—è](#31-lock-–Ω–µ-–∑–≤—ñ–ª—å–Ω–∏–≤—Å—è)
  - [3.2 TTL –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è –ø–µ—Ä–µ–¥—á–∞—Å–Ω–æ](#32-ttl-–∑–∞–∫—ñ–Ω—á–∏–≤—Å—è-–ø–µ—Ä–µ–¥—á–∞—Å–Ω–æ)
  - [3.3 Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π](#33-redis-–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π)
  - [3.4 Race Condition –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ](#34-race-condition-–ø—Ä–∏-–ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ)
  - [3.5 Split Brain (Network Partition)](#35-split-brain-network-partition)
  - [3.6 –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —á—É–∂–æ–≥–æ –ª–æ–∫—É](#36-–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ-–∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è-—á—É–∂–æ–≥–æ-–ª–æ–∫—É)

---

## –î–æ–º–µ–Ω: –ë—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∞–≤—ñ–∞–∫–≤–∏—Ç–∫—ñ–≤

| –ü–∞—Ä–∞–º–µ—Ç—Ä         | –ó–Ω–∞—á–µ–Ω–Ω—è                            |
| ---------------- | ----------------------------------- |
| –°—Ü–µ–Ω–∞—Ä—ñ–π         | –ö–ª—ñ—î–Ω—Ç –±—Ä–æ–Ω—é—î —Ä–µ–π—Å –ö–∏—ó–≤ ‚Üí –ë–∞—Ä—Å–µ–ª–æ–Ω–∞ |
| –ü–∞—Ç–µ—Ä–Ω           | Saga Orchestration                  |
| Lock –º–µ—Ö–∞–Ω—ñ–∑–º    | Redis Distributed Lock              |
| Lock TTL         | 15 —Ö–≤–∏–ª–∏–Ω                           |
| Failure —Å—Ü–µ–Ω–∞—Ä—ñ–π | –ü–ª–∞—Ç—ñ–∂ –≤—ñ–¥—Ö–∏–ª–µ–Ω–æ (Card Declined)    |

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 1: Sequence –¥—ñ–∞–≥—Ä–∞–º–∞ –ø—Ä–æ—Ü–µ—Å—É –≤—ñ–¥–∫–∞—Ç—É

### 1.1 –ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞ —Å–∏—Å—Ç–µ–º–∏

| –°–µ—Ä–≤—ñ—Å               | –†–æ–ª—å                                       |
| -------------------- | ------------------------------------------ |
| Web App              | Frontend —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –∫–ª—ñ—î–Ω—Ç–∞             |
| API Gateway          | –¢–æ—á–∫–∞ –≤—Ö–æ–¥—É, –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü—ñ—è –∑–∞–ø–∏—Ç—ñ–≤         |
| Booking Orchestrator | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä Saga ‚Äî –∫–µ—Ä—É—î –≤—Å—ñ–º –ø—Ä–æ—Ü–µ—Å–æ–º     |
| Message Broker       | –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è (–∫–æ–º–∞–Ω–¥–∏/–≤—ñ–¥–ø–æ–≤—ñ–¥—ñ) |
| Booking Service      | –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è–º–∏       |
| Flight Service       | –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ —Ä–µ–π—Å–∏, –≤–∞–ª—ñ–¥–∞—Ü—ñ—è            |
| Seat Service         | –†–µ–∑–µ—Ä–≤–∞—Ü—ñ—è –º—ñ—Å—Ü—å + distributed lock        |
| Redis                | –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è distributed locks               |
| Baggage Service      | –†–µ–∑–µ—Ä–≤–∞—Ü—ñ—è –±–∞–≥–∞–∂—É                          |
| Pricing Service      | –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ –≤–∞—Ä—Ç–æ—Å—Ç—ñ                        |
| Payment Service      | –û–±—Ä–æ–±–∫–∞ –ø–ª–∞—Ç–µ–∂—ñ–≤                           |
| Notification Service | –°–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤                    |

**–ê—Ä—Ö—ñ—Ç–µ–∫—Ç—É—Ä–∞:**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Customer                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                         Web App                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                       API Gateway                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Booking Orchestrator                          ‚îÇ
‚îÇ                    (Saga Coordinator)                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                              ‚îÇ
                              ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Message Broker                             ‚îÇ
‚îÇ                   (RabbitMQ / Kafka)                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ         ‚îÇ         ‚îÇ         ‚îÇ         ‚îÇ         ‚îÇ
    ‚ñº         ‚ñº         ‚ñº         ‚ñº         ‚ñº         ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇBooking‚îÇ ‚îÇFlight ‚îÇ ‚îÇ Seat  ‚îÇ ‚îÇBaggage‚îÇ ‚îÇPricing‚îÇ ‚îÇPayment‚îÇ
‚îÇService‚îÇ ‚îÇService‚îÇ ‚îÇService‚îÇ ‚îÇService‚îÇ ‚îÇService‚îÇ ‚îÇService‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚îÇ
                        ‚ñº
                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                   ‚îÇ  Redis  ‚îÇ
                   ‚îÇ (Locks) ‚îÇ
                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

### 1.2 Saga Pattern

**–©–æ —Ç–∞–∫–µ Saga?**

–í –º–æ–Ω–æ–ª—ñ—Ç—ñ –≤—Å–µ –ø—Ä–æ—Å—Ç–æ ‚Äî –æ–¥–Ω–∞ –ë–î, –æ–¥–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è:

```sql
BEGIN TRANSACTION;
  UPDATE inventory SET quantity = quantity - 1;
  UPDATE accounts SET balance = balance - 100;
  INSERT INTO orders (...);
COMMIT; -- –∞–±–æ ROLLBACK —è–∫—â–æ —â–æ—Å—å –≤–ø–∞–ª–æ
```

–í –º—ñ–∫—Ä–æ—Å–µ—Ä–≤—ñ—Å–∞—Ö –∫–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å –º–∞—î **—Å–≤–æ—é –±–∞–∑—É** ‚Äî –Ω–µ–º–∞—î —Å–ø—ñ–ª—å–Ω–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.

**Saga** ‚Äî —Ü–µ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω—ñ—Å—Ç—å –ª–æ–∫–∞–ª—å–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π, –¥–µ –∫–æ–∂–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –æ–Ω–æ–≤–ª—é—î –æ–¥–∏–Ω —Å–µ—Ä–≤—ñ—Å. –ó–∞–º—ñ—Å—Ç—å –æ–¥–Ω–æ–≥–æ `ROLLBACK` ‚Äî —Å–µ—Ä—ñ—è **–∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ–π–Ω–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π**:

```
–ó–≤–∏—á–∞–π–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è:    T1 ‚Üí T2 ‚Üí T3 ‚Üí T4
                                      ‚Üì (–ø–∞–¥–∞—î)
–ö–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è:            C1 ‚Üê C2 ‚Üê C3 ‚Üê‚îò
```

---

### 1.3 Orchestration vs Choreography

| –ê—Å–ø–µ–∫—Ç                  | Orchestration           | Choreography                       |
| ----------------------- | ----------------------- | ---------------------------------- |
| –ö–µ—Ä—É–≤–∞–Ω–Ω—è               | –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä | –ö–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å —Å–∞–º –≤–∏—Ä—ñ—à—É—î           |
| –ö–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è             | Commands (–Ω–∞–∫–∞–∑–∏)       | Events (–ø–æ–¥—ñ—ó)                     |
| –°–µ–º–∞–Ω—Ç–∏–∫–∞               | "–ó—Ä–æ–±–∏ —â–æ—Å—å"            | "–©–æ—Å—å —Å—Ç–∞–ª–æ—Å—è"                     |
| Rollback                | Orchestrator –∫–µ—Ä—É—î      | –ö–æ–∂–µ–Ω —Å–µ—Ä–≤—ñ—Å —Å–ª—É—Ö–∞—î failure events |
| –°–∫–ª–∞–¥–Ω—ñ—Å—Ç—å              | –í –æ–¥–Ω–æ–º—É –º—ñ—Å—Ü—ñ          | –†–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∞                        |
| Single Point of Failure | –¢–∞–∫ (Orchestrator)      | –ù—ñ                                 |
| –í–∏–¥–∏–º—ñ—Å—Ç—å flow          | –õ–µ–≥–∫–æ –∑—Ä–æ–∑—É–º—ñ—Ç–∏         | –í–∞–∂–∫–æ –≤—ñ–¥—Å–ª—ñ–¥–∫—É–≤–∞—Ç–∏                |

**–û–±—Ä–∞–Ω–æ: Orchestration** ‚Äî –¥–ª—è –Ω–∞–æ—á–Ω–æ—Å—Ç—ñ rollback –ø—Ä–æ—Ü–µ—Å—É —Ç–∞ —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ–≥–æ –∫–µ—Ä—É–≤–∞–Ω–Ω—è.

---

### 1.4 –î—ñ–∞–≥—Ä–∞–º–∞

![Saga Orchestration Rollback](saga-orchestration-rollback.png)

**–ö–æ–¥ –¥—ñ–∞–≥—Ä–∞–º–∏:** [saga-orchestration-rollback.puml](saga-orchestration-rollback.puml)

---

### 1.5 –ï—Ç–∞–ø–∏ –ø—Ä–æ—Ü–µ—Å—É

#### –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (Happy Path)

| #   | –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è      | –°–µ—Ä–≤—ñ—Å       | –û–ø–∏—Å                             | –ö–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è     |
| --- | --------------- | ------------ | -------------------------------- | --------------- |
| T1  | Create Booking  | Booking      | –°—Ç–≤–æ—Ä–∏—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è (PENDING)    | CancelBooking   |
| T2  | Validate Flight | Flight       | –ü–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ —Ä–µ–π—Å (read-only)      | ‚Äî               |
| T3  | Reserve Seat    | Seat + Redis | –ó–∞—Ä–µ–∑–µ—Ä–≤—É–≤–∞—Ç–∏ –º—ñ—Å—Ü–µ + lock       | ReleaseSeat     |
| T4  | Reserve Baggage | Baggage      | –ó–∞—Ä–µ–∑–µ—Ä–≤—É–≤–∞—Ç–∏ –±–∞–≥–∞–∂              | ReleaseBaggage  |
| T5  | Calculate Price | Pricing      | –†–æ–∑—Ä–∞—Ö—É–≤–∞—Ç–∏ –≤–∞—Ä—Ç—ñ—Å—Ç—å (read-only) | ‚Äî               |
| T6  | Process Payment | Payment      | –°–ø–∏—Å–∞—Ç–∏ –∫–æ—à—Ç–∏                    | RefundPayment\* |

\*RefundPayment –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –æ–ø–ª–∞—Ç–∞ –ø—Ä–æ–π—à–ª–∞ —É—Å–ø—ñ—à–Ω–æ.

#### Failure Scenario: Card Declined

```
T1 ‚úÖ ‚Üí T2 ‚úÖ ‚Üí T3 ‚úÖ ‚Üí T4 ‚úÖ ‚Üí T5 ‚úÖ ‚Üí T6 ‚ùå (CARD_DECLINED)
                                          ‚îÇ
                                          ‚ñº
                              ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROLLBACK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                                          ‚îÇ
                              C3: ReleaseBaggage ‚úÖ
                                          ‚îÇ
                              C2: ReleaseSeat ‚úÖ
                                          ‚îÇ
                              C1: CancelBooking ‚úÖ
```

#### –ö–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó (Rollback Sequence)

| #   | –ö–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è    | –°–µ—Ä–≤—ñ—Å       | –û–ø–∏—Å                            |
| --- | -------------- | ------------ | ------------------------------- |
| C3  | ReleaseBaggage | Baggage      | –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ –±–∞–≥–∞–∂–Ω—É –∫–≤–æ—Ç—É         |
| C2  | ReleaseSeat    | Seat + Redis | –ó–≤—ñ–ª—å–Ω–∏—Ç–∏ –º—ñ—Å—Ü–µ + –≤–∏–¥–∞–ª–∏—Ç–∏ lock |
| C1  | CancelBooking  | Booking      | –°–∫–∞—Å—É–≤–∞—Ç–∏ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è            |

**–í–∞–∂–ª–∏–≤–æ:**

- –ö–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è —É **–∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É**
- T2 —ñ T5 ‚Äî read-only, –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—è –Ω–µ –ø–æ—Ç—Ä—ñ–±–Ω–∞
- T6 –Ω–µ –ø–æ—Ç—Ä–µ–±—É—î –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó, –±–æ –ø–ª–∞—Ç—ñ–∂ –Ω–µ –ø—Ä–æ–π—à–æ–≤

---

### 1.6 –¢–∏–ø–∏ —Å—Ç—Ä—ñ–ª–æ–∫

| –°—Ç—Ä—ñ–ª–∫–∞ | –°–∏–Ω—Ç–∞–∫—Å–∏—Å           | –¢–∏–ø            | –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è                            |
| ------- | ------------------- | -------------- | --------------------------------------- |
| `->`    | –°—É—Ü—ñ–ª—å–Ω–∞, –∑–∞–∫—Ä–∏—Ç–∞   | Sync request   | HTTP –∑–∞–ø–∏—Ç (Customer ‚Üí Gateway)         |
| `-->`   | –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞, –∑–∞–∫—Ä–∏—Ç–∞  | Sync response  | HTTP –≤—ñ–¥–ø–æ–≤—ñ–¥—å                          |
| `->>`   | –°—É—Ü—ñ–ª—å–Ω–∞, –≤—ñ–¥–∫—Ä–∏—Ç–∞  | Async message  | –ö–æ–º–∞–Ω–¥–∞ –≤ —á–µ—Ä–≥—É (Orchestrator ‚Üí Broker) |
| `-->>`  | –ü—É–Ω–∫—Ç–∏—Ä–Ω–∞, –≤—ñ–¥–∫—Ä–∏—Ç–∞ | Async response | –í—ñ–¥–ø–æ–≤—ñ–¥—å —á–µ—Ä–µ–∑ —á–µ—Ä–≥—É                   |

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 2: –õ–æ–≥—ñ–∫–∞ –ª–æ–∫—É —Ç–æ–≤–∞—Ä—É

### 2.1 –ü—Ä–æ–±–ª–µ–º–∞: Race Condition

–î–≤–∞ –∫–ª—ñ—î–Ω—Ç–∏ –æ–¥–Ω–æ—á–∞—Å–Ω–æ —Ö–æ—á—É—Ç—å –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –º—ñ—Å—Ü–µ 12A:

```
–ß–∞—Å     –ö–ª—ñ—î–Ω—Ç –ê                         –ö–ª—ñ—î–Ω—Ç –ë
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
0ms     SELECT seat WHERE id='12A'
5ms                                      SELECT seat WHERE id='12A'
10ms    // status = AVAILABLE
15ms                                     // status = AVAILABLE
20ms    UPDATE seat SET status='RESERVED'
25ms                                     UPDATE seat SET status='RESERVED'
30ms    // Success!
35ms                                     // Success!

üíÄ –†–µ–∑—É–ª—å—Ç–∞—Ç: –û–±–∏–¥–≤–∞ –¥—É–º–∞—é—Ç—å, —â–æ –∑–∞–±—Ä–æ–Ω—é–≤–∞–ª–∏ –º—ñ—Å—Ü–µ 12A
```

---

### 2.2 –†—ñ—à–µ–Ω–Ω—è: Distributed Lock (Redis)

**–ß–æ–º—É Redis?**

| –†—ñ—à–µ–Ω–Ω—è                           | –ü–ª—é—Å–∏                         | –ú—ñ–Ω—É—Å–∏                             |
| --------------------------------- | ----------------------------- | ---------------------------------- |
| Database Lock (SELECT FOR UPDATE) | –ü—Ä–æ—Å—Ç–æ                        | –ù–µ –ø—Ä–∞—Ü—é—î –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏/—ñ–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ |
| Redis Distributed Lock            | –®–≤–∏–¥–∫–∏–π, –ø—Ä–∞—Ü—é—î –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏ | –ü–æ—Ç—Ä–µ–±—É—î Redis                     |
| Zookeeper                         | –ù–∞–¥—ñ–π–Ω–∏–π, CP-—Å–∏—Å—Ç–µ–º–∞          | –°–∫–ª–∞–¥–Ω–∏–π, –ø–æ–≤—ñ–ª—å–Ω—ñ—à–∏–π              |

**Redis –∫–æ–º–∞–Ω–¥–∞:**

```
SET seat:KBP-BCN-0615:12A:lock <unique_id> NX EX 900
```

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–Ω—è                     | –û–ø–∏—Å                                  |
| -------- | ---------------------------- | ------------------------------------- |
| Key      | `seat:KBP-BCN-0615:12A:lock` | –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π –∫–ª—é—á –¥–ª—è —Ä–µ—Å—É—Ä—Å—É           |
| Value    | `<unique_id>`                | UUID –ø—Ä–æ—Ü–µ—Å—É (–¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ release) |
| NX       | ‚Äî                            | –¢—ñ–ª—å–∫–∏ —è–∫—â–æ –∫–ª—é—á –ù–ï —ñ—Å–Ω—É—î (–∞—Ç–æ–º–∞—Ä–Ω–æ)  |
| EX       | 900                          | TTL 15 —Ö–≤–∏–ª–∏–Ω (900 —Å–µ–∫—É–Ω–¥)            |

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**

- `OK` ‚Äî lock –æ—Ç—Ä–∏–º–∞–Ω–æ
- `NULL` ‚Äî lock –≤–∂–µ —Ç—Ä–∏–º–∞—î —Ö—Ç–æ—Å—å —ñ–Ω—à–∏–π

---

### 2.3 –ê–ª–≥–æ—Ä–∏—Ç–º —Ä–æ–±–æ—Ç–∏

#### Acquire Lock (–û—Ç—Ä–∏–º–∞–Ω–Ω—è)

```
1. –ö–ª—ñ—î–Ω—Ç —Ö–æ—á–µ –∑–∞–±—Ä–æ–Ω—é–≤–∞—Ç–∏ –º—ñ—Å—Ü–µ 12A
           ‚Üì
2. Seat Service ‚Üí Redis: SET lock NX EX 900
           ‚Üì
3. Redis –ø–æ–≤–µ—Ä—Ç–∞—î OK?
           ‚Üì
   –¢–ê–ö ‚Üí Lock –æ—Ç—Ä–∏–º–∞–Ω–æ ‚Üí –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º—ñ—Å—Ü–µ –≤ –ë–î
   –ù–Ü ‚Üí –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –ø–æ–º–∏–ª–∫—É: "–ú—ñ—Å—Ü–µ —Ä–µ–∑–µ—Ä–≤—É—î—Ç—å—Å—è —ñ–Ω—à–∏–º –∫–ª—ñ—î–Ω—Ç–æ–º"
```

#### Release Lock (–ó–≤—ñ–ª—å–Ω–µ–Ω–Ω—è)

```
1. –ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –æ–ø–ª–∞—Ç–∏ –ê–ë–û –ø—Ä–∏ rollback
           ‚Üì
2. Seat Service ‚Üí Redis: DEL lock (–∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –≤–ª–∞—Å–Ω–∏–∫–∞!)
           ‚Üì
3. –ú—ñ—Å—Ü–µ –∑–Ω–æ–≤—É –¥–æ—Å—Ç—É–ø–Ω–µ –¥–ª—è —ñ–Ω—à–∏—Ö
```

#### TTL Expiration (–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è)

```
1. –ö–ª—ñ—î–Ω—Ç –Ω–µ –æ–ø–ª–∞—Ç–∏–≤ –∑–∞ 15 —Ö–≤–∏–ª–∏–Ω
           ‚Üì
2. Redis –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª—è—î –∫–ª—é—á (TTL expired)
           ‚Üì
3. Lock –∑–≤—ñ–ª—å–Ω—è—î—Ç—å—Å—è –±–µ–∑ –≤—Ç—Ä—É—á–∞–Ω–Ω—è
           ‚Üì
4. Orchestrator –æ—Ç—Ä–∏–º—É—î timeout ‚Üí –∑–∞–ø—É—Å–∫–∞—î rollback
```

---

### 2.4 –ü—Ä–∏–∫–ª–∞–¥ –∫–æ–¥—É

```typescript
import Redis from "ioredis";
import { v4 as uuidv4 } from "uuid";

const redis = new Redis();
const LOCK_TTL = 900; // 15 —Ö–≤–∏–ª–∏–Ω

interface LockResult {
  success: boolean;
  lockId?: string;
  error?: string;
}

// ===== ACQUIRE LOCK =====
async function acquireSeatLock(
  flightId: string,
  seatId: string,
): Promise<LockResult> {
  const lockKey = `seat:${flightId}:${seatId}:lock`;
  const lockId = uuidv4(); // –£–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID –¥–ª—è —Ü—ñ—î—ó —Ä–µ–∑–µ—Ä–≤–∞—Ü—ñ—ó

  // –ê—Ç–æ–º–∞—Ä–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è: —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª—é—á —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –Ω–µ —ñ—Å–Ω—É—î
  const acquired = await redis.set(
    lockKey,
    lockId,
    "NX", // Only if Not eXists
    "EX", // Expire time
    LOCK_TTL, // 900 —Å–µ–∫—É–Ω–¥
  );

  if (!acquired) {
    return {
      success: false,
      error: "SEAT_ALREADY_LOCKED",
    };
  }

  return {
    success: true,
    lockId: lockId,
  };
}

// ===== RELEASE LOCK =====
async function releaseSeatLock(
  flightId: string,
  seatId: string,
  lockId: string,
): Promise<boolean> {
  const lockKey = `seat:${flightId}:${seatId}:lock`;

  // Lua script –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ–≥–æ release
  // –í–∏–¥–∞–ª—è—î–º–æ –¢–Ü–õ–¨–ö–ò —è–∫—â–æ –º–∏ –≤–ª–∞—Å–Ω–∏–∫ –ª–æ–∫—É
  const script = `
    if redis.call("GET", KEYS[1]) == ARGV[1] then
      return redis.call("DEL", KEYS[1])
    else
      return 0
    end
  `;

  const released = await redis.eval(script, 1, lockKey, lockId);
  return released === 1;
}

// ===== USAGE IN SEAT SERVICE =====
async function reserveSeat(flightId: string, seatId: string) {
  // 1. –û—Ç—Ä–∏–º—É—î–º–æ lock
  const lock = await acquireSeatLock(flightId, seatId);

  if (!lock.success) {
    throw new Error("Seat is being reserved by another customer");
  }

  // 2. –û–Ω–æ–≤–ª—é—î–º–æ –ë–î
  await db.seats.update({
    where: { flightId, seatId },
    data: {
      status: "RESERVED",
      reservedUntil: new Date(Date.now() + LOCK_TTL * 1000),
      lockId: lock.lockId,
    },
  });

  return {
    seatId,
    lockId: lock.lockId,
    expiresIn: LOCK_TTL,
  };
}

async function releaseSeat(flightId: string, seatId: string, lockId: string) {
  // 1. –ó–≤—ñ–ª—å–Ω—è—î–º–æ lock –≤ Redis
  const released = await releaseSeatLock(flightId, seatId, lockId);

  if (!released) {
    console.warn("Lock was already released or owned by another process");
  }

  // 2. –û–Ω–æ–≤–ª—é—î–º–æ –ë–î
  await db.seats.update({
    where: { flightId, seatId },
    data: {
      status: "AVAILABLE",
      reservedUntil: null,
      lockId: null,
    },
  });
}
```

---

## –ó–∞–≤–¥–∞–Ω–Ω—è 3: –©–æ –º–æ–∂–µ –ø—ñ—Ç–∏ –Ω–µ —Ç–∞–∫ –∑ –ª–æ–∫–æ–º

### 3.1 Lock –Ω–µ –∑–≤—ñ–ª—å–Ω–∏–≤—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –°–µ—Ä–≤—ñ—Å –≤–ø–∞–≤ –ø—ñ—Å–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è lock, –∞–ª–µ –¥–æ –π–æ–≥–æ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è.

```
1. Seat Service –æ—Ç—Ä–∏–º—É—î lock
2. Seat Service –ø–∞–¥–∞—î (crash, OOM, network)
3. Lock –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ Redis
4. –ú—ñ—Å—Ü–µ 12A –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–µ –Ω–∞–∑–∞–≤–∂–¥–∏ üíÄ
```

**–†—ñ—à–µ–Ω–Ω—è: TTL (Time To Live)**

```
SET lock NX EX 900  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ 15 —Ö–≤
```

Redis —Å–∞–º –≤–∏–¥–∞–ª–∏—Ç—å lock –ø—ñ—Å–ª—è TTL, –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —Å–µ—Ä–≤—ñ—Å –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î.

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ TTL –¥–ª—è locks.

---

### 3.2 TTL –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è –ø–µ—Ä–µ–¥—á–∞—Å–Ω–æ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û–ø–µ—Ä–∞—Ü—ñ—è –∑–∞–π–º–∞—î –±—ñ–ª—å—à–µ —á–∞—Å—É –Ω—ñ–∂ TTL.

```
1. –ö–ª—ñ—î–Ω—Ç –ê –æ—Ç—Ä–∏–º—É—î lock (TTL = 15 —Ö–≤)
2. –ö–ª—ñ—î–Ω—Ç –ê –ø–æ–≤—ñ–ª—å–Ω–æ –∑–∞–ø–æ–≤–Ω—é—î —Ñ–æ—Ä–º—É... ‚òï
3. –ß–µ—Ä–µ–∑ 15 —Ö–≤ TTL –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, Redis –≤–∏–¥–∞–ª—è—î lock
4. –ö–ª—ñ—î–Ω—Ç –ë –æ—Ç—Ä–∏–º—É—î lock –Ω–∞ —Ç–µ —Å–∞–º–µ –º—ñ—Å—Ü–µ
5. –ö–ª—ñ—î–Ω—Ç –ê –∑–∞–≤–µ—Ä—à—É—î –æ–ø–ª–∞—Ç—É
6. üíÄ –û–±–∏–¥–≤–∞ –º–∞—é—Ç—å –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–µ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –Ω–∞ –º—ñ—Å—Ü–µ 12A!
```

**–†—ñ—à–µ–Ω–Ω—è: Lock Extension (Watchdog)**

```typescript
// –§–æ–Ω–æ–≤–∏–π –ø—Ä–æ—Ü–µ—Å –ø—Ä–æ–¥–æ–≤–∂—É—î TTL –ø–æ–∫–∏ –æ–ø–µ—Ä–∞—Ü—ñ—è –∞–∫—Ç–∏–≤–Ω–∞
class LockWatchdog {
  private intervalId: NodeJS.Timeout;

  start(lockKey: string, lockId: string, ttl: number) {
    // –ö–æ–∂–Ω—ñ TTL/3 —Å–µ–∫—É–Ω–¥ –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —ñ –ø—Ä–æ–¥–æ–≤–∂—É—î–º–æ
    this.intervalId = setInterval(
      async () => {
        const extended = await this.extendLock(lockKey, lockId, ttl);
        if (!extended) {
          // Lock –≤—Ç—Ä–∞—á–µ–Ω–æ ‚Äî –∑—É–ø–∏–Ω—è—î–º–æ –æ–ø–µ—Ä–∞—Ü—ñ—é
          this.stop();
          throw new Error("Lock lost");
        }
      },
      (ttl / 3) * 1000,
    );
  }

  private async extendLock(key: string, id: string, ttl: number) {
    const script = `
      if redis.call("GET", KEYS[1]) == ARGV[1] then
        return redis.call("EXPIRE", KEYS[1], ARGV[2])
      else
        return 0
      end
    `;
    return await redis.eval(script, 1, key, id, ttl);
  }

  stop() {
    clearInterval(this.intervalId);
  }
}
```

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –î–ª—è –¥–æ–≤–≥–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ watchdog –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è TTL.

---

### 3.3 Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π

**–ü—Ä–æ–±–ª–µ–º–∞:** Redis –≤–ø–∞–≤ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É.

```
1. Seat Service ‚Üí Redis: SET lock
2. Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π (crash, network partition)
3. Seat Service –Ω–µ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ lock
4. –í—Å—ñ –±—Ä–æ–Ω—é–≤–∞–Ω–Ω—è –∑—É–ø–∏–Ω—è—é—Ç—å—Å—è üíÄ
```

**–†—ñ—à–µ–Ω–Ω—è 1: Fallback –Ω–∞ database lock**

```typescript
async function acquireLockWithFallback(flightId: string, seatId: string) {
  try {
    // –°–ø–æ—á–∞—Ç–∫—É –ø—Ä–æ–±—É—î–º–æ Redis
    return await acquireRedisLock(flightId, seatId);
  } catch (redisError) {
    console.warn("Redis unavailable, falling back to DB lock");
    // Fallback –Ω–∞ SELECT FOR UPDATE
    return await acquireDatabaseLock(flightId, seatId);
  }
}
```

**–†—ñ—à–µ–Ω–Ω—è 2: Redis Cluster / Sentinel**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redis   ‚îÇ     ‚îÇ Redis   ‚îÇ     ‚îÇ Redis   ‚îÇ
‚îÇ Master  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Replica ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ Replica ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     ‚îÇ
     ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇSentinel ‚îÇ ‚Üê –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π failover
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Redis Cluster/Sentinel –∞–±–æ –º–∞—Ç–∏ fallback —Å—Ç—Ä–∞—Ç–µ–≥—ñ—é.

---

### 3.4 Race Condition –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ

**–ü—Ä–æ–±–ª–µ–º–∞:** Check-then-act –±–µ–∑ –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—ñ.

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî race condition!
async function badAcquireLock(key: string) {
  const exists = await redis.exists(key); // –ö—Ä–æ–∫ 1: –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞
  if (!exists) {
    await redis.set(key, "locked"); // –ö—Ä–æ–∫ 2: –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è
    return true;
  }
  return false;
}
```

```
–ß–∞—Å     –ü—Ä–æ—Ü–µ—Å –ê                    –ü—Ä–æ—Ü–µ—Å –ë
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
0ms     EXISTS key ‚Üí 0 (–Ω–µ —ñ—Å–Ω—É—î)
5ms                                 EXISTS key ‚Üí 0 (–Ω–µ —ñ—Å–Ω—É—î)
10ms    SET key "locked"
15ms                                SET key "locked"
20ms    // –¥—É–º–∞—î —â–æ –º–∞—î lock
25ms                                // —Ç–µ–∂ –¥—É–º–∞—î —â–æ –º–∞—î lock üíÄ
```

**–†—ñ—à–µ–Ω–Ω—è: –ê—Ç–æ–º–∞—Ä–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è NX**

```typescript
// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–∞ –æ–ø–µ—Ä–∞—Ü—ñ—è
async function goodAcquireLock(key: string, value: string, ttl: number) {
  // SET –∑ NX ‚Äî –∞—Ç–æ–º–∞—Ä–Ω–æ –ø–µ—Ä–µ–≤—ñ—Ä—è—î –Ü –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î
  const result = await redis.set(key, value, "NX", "EX", ttl);
  return result === "OK";
}
```

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –ó–∞–≤–∂–¥–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∞—Ç–æ–º–∞—Ä–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó (`SET NX`), –Ω—ñ–∫–æ–ª–∏ –Ω–µ —Ä–æ–∑–¥—ñ–ª—è—Ç–∏ check —ñ act.

---

### 3.5 Split Brain (Network Partition)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–µ—Ä–µ–∂–µ–≤–∏–π —Ä–æ–∑–¥—ñ–ª –º—ñ–∂ Redis –Ω–æ–¥–∞–º–∏.

```
       Network Partition
            ‚ïë
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           ‚ïë           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚ïë  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇRedis‚îÇ  ‚ïë  ‚îÇRedis‚îÇ  ‚îÇ
‚îÇ  ‚îÇNode1‚îÇ  ‚ïë  ‚îÇNode2‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò  ‚ïë  ‚îî‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ     ‚îÇ     ‚ïë     ‚îÇ     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê  ‚ïë  ‚îå‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇApp A‚îÇ  ‚ïë  ‚îÇApp B‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚ïë  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ           ‚ïë           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïë‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

App A –æ—Ç—Ä–∏–º—É—î lock –Ω–∞ Node1
App B –æ—Ç—Ä–∏–º—É—î lock –Ω–∞ Node2
üíÄ –û–±–∏–¥–≤–∞ –º–∞—é—Ç—å lock –Ω–∞ —Ç–æ–π —Å–∞–º–∏–π —Ä–µ—Å—É—Ä—Å!
```

**–†—ñ—à–µ–Ω–Ω—è: Redlock Algorithm**

```typescript
// Redlock ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ñ–¥ —Ç–≤–æ—Ä—Ü—ñ–≤ Redis
// –ü–æ—Ç—Ä–µ–±—É—î –Ω–µ–ø–∞—Ä–Ω—É –∫—ñ–ª—å–∫—ñ—Å—Ç—å –Ω–µ–∑–∞–ª–µ–∂–Ω–∏—Ö Redis —ñ–Ω—Å—Ç–∞–Ω—Å—ñ–≤ (–∑–∞–∑–≤–∏—á–∞–π 5)

import Redlock from "redlock";

const redlock = new Redlock([redis1, redis2, redis3, redis4, redis5], {
  retryCount: 3,
  retryDelay: 200,
});

// Lock –≤–≤–∞–∂–∞—î—Ç—å—Å—è –æ—Ç—Ä–∏–º–∞–Ω–∏–º —è–∫—â–æ –±—ñ–ª—å—à—ñ—Å—Ç—å (3 –∑ 5) –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–ª–∏
const lock = await redlock.acquire(["seat:12A:lock"], 15000);
```

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –î–ª—è –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö —Å–∏—Å—Ç–µ–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ Redlock –∑ –∫—ñ–ª—å–∫–æ–º–∞ –Ω–µ–∑–∞–ª–µ–∂–Ω–∏–º–∏ Redis —ñ–Ω—Å—Ç–∞–Ω—Å–∞–º–∏.

---

### 3.6 –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —á—É–∂–æ–≥–æ –ª–æ–∫—É

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü—Ä–æ—Ü–µ—Å –∑–≤—ñ–ª—å–Ω—è—î lock, —è–∫–∏–π –π–æ–º—É –Ω–µ –Ω–∞–ª–µ–∂–∏—Ç—å.

```
1. –ü—Ä–æ—Ü–µ—Å –ê –æ—Ç—Ä–∏–º—É—î lock (lockId = "aaa")
2. TTL –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è, Redis –≤–∏–¥–∞–ª—è—î lock
3. –ü—Ä–æ—Ü–µ—Å –ë –æ—Ç—Ä–∏–º—É—î lock (lockId = "bbb")
4. –ü—Ä–æ—Ü–µ—Å –ê –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è –∑–≤—ñ–ª—å–Ω–∏—Ç–∏ lock
5. –ü—Ä–æ—Ü–µ—Å –ê –≤–∏–∫–æ–Ω—É—î DEL key
6. üíÄ –ü—Ä–æ—Ü–µ—Å –ê –≤–∏–¥–∞–ª–∏–≤ lock –ø—Ä–æ—Ü–µ—Å—É –ë!
```

**–†—ñ—à–µ–Ω–Ω—è: –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–ª–∞—Å–Ω–∏–∫–∞ –ø–µ—Ä–µ–¥ –≤–∏–¥–∞–ª–µ–Ω–Ω—è–º**

```typescript
// ‚ùå –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –≤–∏–¥–∞–ª—è—î –±—É–¥—å-—è–∫–∏–π lock
await redis.del(lockKey);

// ‚úÖ –ü–†–ê–í–ò–õ–¨–ù–û ‚Äî –≤–∏–¥–∞–ª—è—î —Ç—ñ–ª—å–∫–∏ —Å–≤—ñ–π lock (Lua script –¥–ª—è –∞—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—ñ)
const script = `
  if redis.call("GET", KEYS[1]) == ARGV[1] then
    return redis.call("DEL", KEYS[1])
  else
    return 0
  end
`;
await redis.eval(script, 1, lockKey, myLockId);
```

‚úÖ **–í–∏—Å–Ω–æ–≤–æ–∫:** –ó–∞–≤–∂–¥–∏ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π lockId —ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ –ø–µ—Ä–µ–¥ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è–º.

---

## –ü—ñ–¥—Å—É–º–æ–∫ –ø—Ä–æ–±–ª–µ–º —Ç–∞ —Ä—ñ—à–µ–Ω—å

| #   | –ü—Ä–æ–±–ª–µ–º–∞              | –†—ñ—à–µ–Ω–Ω—è                           |
| --- | --------------------- | --------------------------------- |
| 1   | Lock –Ω–µ –∑–≤—ñ–ª—å–Ω–∏–≤—Å—è    | TTL –Ω–∞ –∫–æ–∂–µ–Ω lock                 |
| 2   | TTL –∑–∞–∫—ñ–Ω—á–∏–≤—Å—è —Ä–∞–Ω–æ   | Watchdog –¥–ª—è –ø—Ä–æ–¥–æ–≤–∂–µ–Ω–Ω—è          |
| 3   | Redis –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π     | Cluster/Sentinel + fallback       |
| 4   | Race condition        | –ê—Ç–æ–º–∞—Ä–Ω—ñ –æ–ø–µ—Ä–∞—Ü—ñ—ó (SET NX)        |
| 5   | Split brain           | Redlock algorithm                 |
| 6   | –í–∏–¥–∞–ª–µ–Ω–Ω—è —á—É–∂–æ–≥–æ –ª–æ–∫—É | –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ lockId —á–µ—Ä–µ–∑ Lua script |

---

## –í–∏—Å–Ω–æ–≤–∫–∏

| –ó–∞–≤–¥–∞–Ω–Ω—è                   | –°—Ç–∞—Ç—É—Å |
| -------------------------- | ------ |
| Sequence –¥—ñ–∞–≥—Ä–∞–º–∞ rollback | ‚úÖ     |
| –õ–æ–≥—ñ–∫–∞ –ª–æ–∫—É (Redis)        | ‚úÖ     |
| –ü—Ä–æ–±–ª–µ–º–∏ –∑ –ª–æ–∫–∞–º–∏          | ‚úÖ     |

### –ö–ª—é—á–æ–≤—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó

1. **Saga Pattern** ‚Äî —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è–º–∏ —á–µ—Ä–µ–∑ –∫–æ–º–ø–µ–Ω—Å–∞—Ü—ñ—ó
2. **Orchestration** ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∏–π –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä –∫–µ—Ä—É—î flow —ñ rollback
3. **Distributed Lock** ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –º—ñ–∂ —Å–µ—Ä–≤—ñ—Å–∞–º–∏ —á–µ—Ä–µ–∑ Redis
4. **TTL** ‚Äî –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è –ª–æ–∫—ñ–≤ –¥–ª—è –∑–∞–ø–æ–±—ñ–≥–∞–Ω–Ω—è deadlocks
5. **–ê—Ç–æ–º–∞—Ä–Ω—ñ—Å—Ç—å** ‚Äî SET NX –¥–ª—è –±–µ–∑–ø–µ—á–Ω–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ª–æ–∫—É
6. **Redlock** ‚Äî –∞–ª–≥–æ—Ä–∏—Ç–º –¥–ª—è –Ω–∞–¥—ñ–π–Ω–æ–≥–æ locking –≤ —Ä–æ–∑–ø–æ–¥—ñ–ª–µ–Ω–∏—Ö —Å–∏—Å—Ç–µ–º–∞—Ö

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏

- SequenceDiagram.org ‚Äî —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –¥—ñ–∞–≥—Ä–∞–º
- Redis ‚Äî distributed locking
- Message Broker (RabbitMQ/Kafka) ‚Äî –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è

---
